---
title: "waste-simulation"
author: "Nikola Kovačević"
format: html
editor: visual
---

# Setup

```{r}
library(simmer)
library(simmer.plot)
library(simmer.bricks)
library(parallel)

# Define regions with capacities
regions <- data.frame(
  name = c("Pomurska", "Podravska", "Koroška", "Savinjska", 
           "Zasavska", "Posavska", "Jugovzhodna Slovenija", 
           "Osrednjeslovenska", "Gorenjska", "Primorsko-notranjska", 
           "Goriška", "Obalno-kraška"),
  waste_generation_rate = c(1.2, 1.5, 0.8, 1.3, 0.7, 0.9, 1.1, 1.6, 1.4, 1, 1.3, 1.2),
  waste_collection_rate = c(1.1, 1.3, 0.9, 1.2, 0.8, 1.0, 1.0, 1.5, 1.3, 0.9, 1.2, 1.1),
  waste_handling_rate = c(1.0, 1.2, 0.8, 1.1, 0.7, 0.9, 1.0, 1.4, 1.2, 0.8, 1.1, 1.0),
  storage_capacity = rep(10, 12)  # Not directly used in simulation; example capacities
)
```

# Define resources (assuming central facility)

## Generation - this process involves generating wood waste in each region

## Collection - this process involves transporting wood waste from each region to a central handling facility

## Handling - this process involves handling the wood waste at the central facility

# Test Framework 1

```{r}

env <- simmer("WoodWasteManagement")

# Assume each region generates between 1 to 5 units of wood waste randomly every 1 to 10 minutes
# This is a simplification, using test data
generate_wood_waste <- function(region) {
  trajectory(paste(region, "wood waste process")) |>
    log_(paste("Generating wood waste in", region)) |>
    timeout(function() runif(1, 1, 5)) |>
    log_(paste("Wood waste ready for collection in", region))
}

# Define a trajectory for transportation to a central handling facility
# This is simplified; distances and transport times would affect this in a real model
transport_to_facility <- trajectory("transportation") |>
  log_("Transporting to facility") |>
  timeout(5)  # Simplified transport time

# Handling trajectory
handle_wood_waste <- trajectory("handling") |>
  log_("Handling wood waste") |>
  timeout(3)  # Simplified processing time

# Regions
regions <- c("Pomurska", "Podravska", "Koroška", "Savinjska", "Zasavska", "Posavska", 
             "Jugovzhodna Slovenija", "Osrednjeslovenska", "Gorenjska", 
             "Primorsko-notranjska", "Goriška", "Obalno-kraška")

# Adding generators for each region
for(region in regions) {
  env <- env |>
    add_generator(paste(region, "generator"), generate_wood_waste(region), function() rexp(1, 0.1)) |>
    add_generator(paste(region, "transport"), transport_to_facility, function() rexp(1, 0.1)) |>
    add_generator("Handling facility", handle_wood_waste, function() rexp(1, 0.2))
}

# Run the simulation
env |> run(until = 100) |> now()  # Run for 100 time units as a demonstration

# monitoring
env |> get_mon_arrivals() |> head()

# amount of generated
env |> get_mon_resources() |> head()
```

# Test Framework 2

```{r}
env <- simmer("SloveniaWoodWasteManagement")

# Create a resource for each region with its storage capacity
for (region_name in regions$name) {
  env <- env |> add_resource(region_name, capacity = 10)
}

# Initialize a data frame to store the results
results <- data.frame(
  time = numeric(),
  region = character(),
  event = character(),
  total_amount = numeric(),
  stringsAsFactors = FALSE
)

waste_handling_trajectory <- function(region_name, initial_capacity, waste_collection_rate, waste_handling_rate) {
  trajectory(region_name) |>
    # Generate waste
    timeout(function() runif(1, 0.5, 1.5)) |>
    # Seize waste amount from the resource
    seize(region_name, amount = function() {
      waste_amount <- runif(1, 0.1, 0.5)
      # Log the waste generation
      results <<- rbind(results, data.frame(
        time = now(env),
        region = region_name,
        event = "generated",
        amount = waste_amount,
        stringsAsFactors = FALSE
      ))
      waste_amount
    }) |>
    # Simulate waste collection time
    timeout(function() rexp(1, rate = waste_collection_rate)) |>
    # Release the seized amount and log the waste collection
    release(region_name, amount = function() {
      seized_amount <- get_seized(env, region_name)
      # Log the waste collection
      results <<- rbind(results, data.frame(
        time = now(env),
        region = region_name,
        event = "collected",
        amount = seized_amount,
        stringsAsFactors = FALSE
      ))
      seized_amount
    }) |>
    # Simulate waste handling time
    timeout(function() rexp(1, rate = waste_handling_rate)) |>
    # Release the seized amount and log the waste handling
    release(region_name, amount = function() {
      seized_amount <- get_seized(env, region_name)
      # Log the waste handling
      results <<- rbind(results, data.frame(
        time = now(env),
        region = region_name,
        event = "handled",
        amount = seized_amount,
        stringsAsFactors = FALSE
      ))
      seized_amount
    })
}


# Add waste handling generators for each region
for (i in 1:nrow(regions)) {
  region <- regions[i, ]
  env <- env |> add_generator(
    paste(region$name, "Waste Generator"),
    waste_handling_trajectory(region$name, region$storage_capacity, region$waste_collection_rate, region$waste_handling_rate), 
    function() rexp(1, rate = region$waste_generation_rate)
  )
}

# Run the simulation
env |> run(until = 100)

print(results)

# show the results of Goriska for generated waste
# sum the amount
sum(results[results$region == "Primorsko-notranjska" & results$event == "generated", ]$amount)

```

# Test Framework 3

## TO FIX COLLECTION AND HANDLING 

```{r}

env <- simmer("SloveniaWoodWasteManagement")

# Define regions with storage capacities
regions <- data.frame(
  name = c("Pomurska", "Podravska", "Koroška", "Savinjska", 
           "Zasavska", "Posavska", "Jugovzhodna Slovenija", 
           "Osrednjeslovenska", "Gorenjska", "Primorsko-notranjska", 
           "Goriška", "Obalno-kraška"),
  waste_generation_rate = c(1.2, 1.5, 0.8, 1.3, 0.7, 0.9, 1.1, 1.6, 1.4, 1, 1.3, 1.2),
  waste_collection_rate = c(1.1, 1.3, 0.9, 1.2, 0.8, 1.0, 1.0, 1.5, 1.3, 0.9, 1.2, 1.1),  # Example rates for simplicity
  waste_handling_rate = c(1.0, 1.2, 0.8, 1.1, 0.7, 0.9, 1.0, 1.4, 1.2, 0.8, 1.1, 1.0),  # Example rates for simplicity
  storage_capacity = rep(10, 12)  # Example capacities for simplicity
)

num_vehicles <- 5

# Create a resource for each region with its storage capacity
for (region_name in regions$name) {
  env <- env |> add_resource(region_name, capacity = 10)
}

# Initialize a data frame to store the results
results <- data.frame(
  time = numeric(),
  region = character(),
  event = character(),
  total_amount = numeric(),
  stringsAsFactors = FALSE
)

# Define the waste trajectory
waste_trajectory <- function(region_name, waste_collection_rate, waste_handling_rate) {
  trajectory(region_name) %>%
    # Generate waste
    timeout(function() rnorm(1, 15)) %>%
    # Seize waste amount from the resource
    seize(region_name, amount = function() {
      waste_amount <- runif(1, 0.1, 0.5)
      # Log the waste generation
      results <<- rbind(results, data.frame(
        time = now(env),
        region = region_name,
        event = "generated",
        amount = waste_amount,
        stringsAsFactors = FALSE
      ))
      waste_amount
    }) %>%
    # Wait for some time before starting the collection
    # timeout(function() runif(1, 1, 2)) %>%
    # Simulate waste collection time
    timeout(function() rnorm(1, 20)) %>%
    # Seize a vehicle
    seize(paste(region_name, "Vehicles"), amount = 1) %>%
    # Release the seized amount and log the waste collection
    release(region_name, amount = function() {
      seized_amount <- get_seized(env, region_name)
      # Log the waste collection
      results <<- rbind(results, data.frame(
        time = now(env),
        region = region_name,
        event = "collected",
        amount = seized_amount,
        stringsAsFactors = FALSE
      ))
      seized_amount
    }) %>%
    # Release the vehicle
    release(paste(region_name, "Vehicles"), amount = 1) %>%
    # Wait for some time before starting the handling
    # timeout(function() runif(1, 2, 3)) %>%
    # Simulate waste handling time
    timeout(function() rnorm(1, 5)) %>%
    # Release the remaining seized amount and log the waste handling
    release(region_name, amount = function() {
      waste_amount <- get_seized(env, region_name)
      # Log the waste handling
      results <<- rbind(results, data.frame(
        time = now(env),
        region = region_name,
        event = "handled",
        amount = waste_amount,
        stringsAsFactors = FALSE
      ))
      waste_amount
    })
}

# Add waste handling generators for each region
for (i in 1:nrow(regions)) {
  region <- regions[i, ]
  env <- env |> 
    add_resource(paste(region$name, "Vehicles"), capacity = num_vehicles) |> 
    add_generator(
      paste(region$name, "Waste Generator"),
      waste_trajectory(region$name, region$waste_collection_rate, region$waste_handling_rate), 
      function() rexp(1, rate = region$waste_generation_rate)
    )
}
# Run the simulation
env |> run(until = 500)

get_mon_arrivals(env)
get_mon_resources(env)
```
# Test Framework 4 - small working version
```{r}

# env <- simmer("SloveniaWoodWasteManagement")

some_waste <- trajectory("some waste's path") |> 
  ## add a generation activity
  seize("generator", amount = 1) |>
  timeout(function() rnorm(1, 15)) |>
  release("generator", amount = 1) |>
  ## add a collection activity
  seize("collector", amount = 1) |>
  timeout(function() rnorm(1, 20)) |>
  release("collector", amount = 1) |>
  ## add a handling activity
  seize("handler", amount = 1) |>
  timeout(function() rnorm(1, 5)) |>
  release("handler", amount = 1)

env |> 
  add_resource("generator", capacity = 10) |> 
  add_resource("collector", capacity = 5) |> 
  add_resource("handler", capacity = 2) |> 
  add_generator("some waste", some_waste, function() rexp(1, rate = 1)) 

env |> 
  run(100) |> 
  now()

env |> peek(3)

env |> 
  stepn() |> 
  print() |> 
  stepn(5)


envs <- mclapply(1:100, function(i) {
  simmer("SuperDuperSim") %>%
    add_resource("generator", 1) %>%
    add_resource("collector", 2) %>%
    add_resource("handler", 1) %>%
    add_generator("some waste", some_waste, function() rnorm(1, 10, 2)) %>%
    run(80) %>%
    wrap()
})

resources <- get_mon_resources(envs)
plot(resources, metric = "utilization")

plot(resources, metric = "usage", c("generator", "collector"), items = "server")

arrivals <- get_mon_arrivals(envs)
plot(arrivals, metric = "flow_time")

plot(arrivals, metric = "activity_time")

plot(arrivals, metric = "waiting_time")

get_palette <- scales::brewer_pal(type = "qual", palette = 1)
plot(some_waste, fill = get_palette)

```
# Plot 

```{r}

arrivals <- get_mon_arrivals(env)
plot(arrivals, metric = "flow_time")

library(ggplot2)

# Convert the event column to a factor
results$event <- as.factor(results$event)

# Create a plot
ggplot(results, aes(x = time, y = amount, color = event)) +
  geom_line() +
  labs(title = "Waste Management Simulation",
       x = "Time",
       y = "Amount",
       color = "Event") +
  theme_minimal()

```
